<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>İmtihan Dünyası</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PeerJS (P2P Bağlantı için) -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <!-- Confetti Efekti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- React ve Bağımlılıklar -->
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "lucide-react": "https://esm.sh/lucide-react@0.292.0"
        }
      }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        
        body { 
            font-family: 'Outfit', sans-serif; 
            background-color: #020617; 
            -webkit-tap-highlight-color: transparent; 
            overflow: hidden; /* Scrollbar gizleme */
        }
        
        /* Özel Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.5); }
        ::-webkit-scrollbar-thumb { background: rgba(99, 102, 241, 0.3); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(99, 102, 241, 0.6); }
        
        /* Animasyonlar */
        .animate-enter { animation: enter 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .animate-pulse-slow { animation: pulseSlow 3s infinite; }
        .animate-float { animation: float 6s ease-in-out infinite; }
        .animate-scan { animation: scan 2s linear infinite; }
        
        @keyframes enter { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes pop { 0% { transform: scale(0.9); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes pulseSlow { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        @keyframes scan { 0% { background-position: 0% 0%; } 100% { background-position: 0% 100%; } }

        /* Gelişmiş Glassmorphism */
        .glass-panel { 
            background: rgba(15, 23, 42, 0.65); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
        
        .glass-panel-light {
            background: rgba(255, 255, 255, 0.03); 
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Slider */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%;
            background: #818cf8; margin-top: -7px; box-shadow: 0 0 15px rgba(129, 140, 248, 0.5); cursor: pointer; transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px;
        }

        /* Glitch Effect for Admin Panel */
        .glitch-text {
            font-family: 'Share Tech Mono', monospace;
            position: relative;
        }
        .admin-overlay {
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.9),
                rgba(0, 0, 0, 0.9) 1px,
                rgba(0, 20, 0, 0.9) 1px,
                rgba(0, 20, 0, 0.9) 2px
            );
        }
    </style>
</head>
<body class="text-slate-100 min-h-[100dvh] bg-slate-950">
    <!-- Dinamik Arka Plan -->
    <div class="fixed inset-0 z-[-2] bg-[url('https://images.unsplash.com/photo-1639322537228-f710d846310a?q=80&w=2232&auto=format&fit=crop')] bg-cover bg-center opacity-40"></div>
    <div class="fixed inset-0 z-[-1] bg-gradient-to-b from-slate-950/80 via-slate-950/90 to-slate-950"></div>
    
    <div id="root" class="h-[100dvh] w-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Play, Users, Trophy, BarChart2, CheckCircle, XCircle, 
            Clock, Brain, ChevronRight, AlertCircle, Copy, 
            LogOut, SplitSquareHorizontal, ChevronDown, ChevronUp, Wifi, Zap, UserPlus, RotateCcw, Home, Eye, Volume2, VolumeX, Crown, Medal, Settings, Sliders, CheckSquare, Square, Shuffle, List, Plus, Trash2, Save,
            ShieldAlert, Lock, Terminal, ThumbsUp, ThumbsDown, Info
        } from 'lucide-react';

        const FIXED_ROOM_ID = "gemini-quiz-master-auto-room-v1";
        const ADMIN_KILL_CODE = "PKT6Y";
        const UNLIMITED_DURATION_THRESHOLD = 630; // 10dk 30sn (sliderdaki max değer bu olacak, bu değer gelirse sınırsız kabul edilecek)

        // --- YARDIMCI FONKSİYON: Zaman Formatlama ---
        const formatTime = (seconds) => {
            if (seconds >= UNLIMITED_DURATION_THRESHOLD) return "Sınırsız";
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            if (m > 0) {
                return `${m}dk${s > 0 ? ' ' + s + 'sn' : ''}`;
            }
            return `${s}sn`;
        };

        // --- YENİ SORU HAVUZU (İnsan Eylemi ve İktisat) ---
        const QUESTION_POOL = [
            { id: 1, text: "İnsan eylemi hangisiyle başlar?", options: ["Rahatsızlık hissiyle", "Refahla", "Zenginlikle", "Tüketimle"], correct: 0 },
            { id: 2, text: "Hangisi kıt bir kaynak değildir?", options: ["Zaman", "Emek", "Hava (normal koşullarda)", "Sermaye"], correct: 2 },
            { id: 3, text: "Marjinal fayda ne demektir?", options: ["Toplam fayda", "Son birimin sağladığı fayda", "Ortalama fayda", "Hiçbiri"], correct: 1 },
            { id: 4, text: "Fiyatların artmasına ne denir?", options: ["Deflasyon", "Enflasyon", "Devalüasyon", "Resesyon"], correct: 1 }
        ];

        // --- SES MOTORU ---
        const SoundEngine = {
            ctx: null, isPlayingMusic: false, musicTimer: null, muted: false,
            
            init: () => {
                if (!SoundEngine.ctx) { SoundEngine.ctx = new (window.AudioContext || window.webkitAudioContext)(); }
                if (SoundEngine.ctx.state === 'suspended') { SoundEngine.ctx.resume(); }
            },
            toggleMute: () => {
                SoundEngine.muted = !SoundEngine.muted;
                if (SoundEngine.muted) SoundEngine.stopMusic();
                else if (window.currentQuizStatus === 'active') {
                    // Mute açıldığında müziği yeniden başlatmak için aktif durumu kontrol etmemiz lazım, 
                    // ama parametreyi burada bilemeyiz. Basitçe standart başlatır, bir sonraki renderda düzelir veya 
                    // basitçe sessiz kalıp playMusic çağrılınca başlar.
                    // Şimdilik sadece durdur/başlat mantığı kalsın.
                } 
                return SoundEngine.muted;
            },
            playTone: (freq, type, duration, startTime, vol = 0.1) => {
                if(SoundEngine.muted) return;
                const ctx = SoundEngine.ctx;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = type; osc.frequency.setValueAtTime(freq, startTime);
                gain.gain.setValueAtTime(vol, startTime); gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
                osc.connect(gain); gain.connect(ctx.destination);
                osc.start(startTime); osc.stop(startTime + duration);
            },
            play: (type) => {
                if(SoundEngine.muted) return;
                SoundEngine.init();
                const ctx = SoundEngine.ctx;
                const now = ctx.currentTime;
                switch (type) {
                    case 'host_create': SoundEngine.playTone(440, 'sine', 0.5, now, 0.1); break;
                    case 'join': SoundEngine.playTone(800, 'sine', 0.1, now, 0.05); break;
                    case 'start': SoundEngine.playTone(220, 'sawtooth', 0.8, now, 0.1); break;
                    case 'finish': [523, 659, 783, 1046].forEach((f, i) => SoundEngine.playTone(f, 'square', 0.3, now + i*0.1, 0.05)); break;
                    case 'victory': [523, 523, 523, 659, 783, 1046].forEach((f, i) => SoundEngine.playTone(f, 'square', [0.1,0.1,0.1,0.15,0.3,0.8][i], now + [0,0.15,0.3,0.45,0.6,0.9][i], 0.1)); break;
                    case 'correct_answer': [523, 659, 783].forEach((f, i) => SoundEngine.playTone(f, 'sine', 0.1, now + i*0.08, 0.1)); break;
                    case 'answer': SoundEngine.playTone(600, 'triangle', 0.1, now, 0.05); break;
                    case 'click': SoundEngine.playTone(800, 'sine', 0.05, now, 0.03); break;
                    case 'error': SoundEngine.playTone(150, 'sawtooth', 0.5, now, 0.2); SoundEngine.playTone(100, 'sawtooth', 0.5, now + 0.1, 0.2); break;
                    case 'destruct': SoundEngine.playTone(1000, 'sawtooth', 0.1, now, 0.2); SoundEngine.playTone(500, 'sawtooth', 0.3, now + 0.1, 0.2); break;
                }
            },
            playMusic: (isUnlimited = false) => {
                if (SoundEngine.isPlayingMusic || SoundEngine.muted) return;
                SoundEngine.init(); SoundEngine.isPlayingMusic = true;
                const loop = () => {
                    if (!SoundEngine.isPlayingMusic || SoundEngine.muted) return;
                    const now = SoundEngine.ctx.currentTime;
                    
                    if (isUnlimited) {
                        // Sınırsız Mod: Sakin, Ambient Melodi (Major 7th Arpeggio)
                        // Daha yumuşak 'sine' dalgaları, yavaş tempo
                        SoundEngine.playTone(329.63, 'sine', 1.5, now, 0.03); // E4
                        SoundEngine.playTone(392.00, 'sine', 1.5, now + 0.8, 0.03); // G4
                        SoundEngine.playTone(493.88, 'sine', 1.5, now + 1.6, 0.03); // B4
                        SoundEngine.playTone(523.25, 'sine', 1.5, now + 2.4, 0.03); // C5
                        
                        SoundEngine.musicTimer = setTimeout(loop, 3500); 
                    } else {
                        // Normal Mod: Gerilim Müziği (Hızlı tempo, keskin sesler)
                        SoundEngine.playTone(110, 'triangle', 0.2, now, 0.1);
                        SoundEngine.playTone(146, 'triangle', 0.2, now+1, 0.1);
                        for(let i=0;i<8;i++) SoundEngine.playTone(2000+(i%2)*500, 'square', 0.02, now+i*0.25, 0.005);
                        SoundEngine.musicTimer = setTimeout(loop, 2000);
                    }
                };
                loop();
            },
            stopMusic: () => {
                SoundEngine.isPlayingMusic = false;
                if (SoundEngine.musicTimer) clearTimeout(SoundEngine.musicTimer);
            }
        };

        window.currentQuizStatus = 'waiting';

        const triggerConfetti = () => {
            const count = 200;
            const defaults = { origin: { y: 0.7 } };
            function fire(particleRatio, opts) {
                confetti(Object.assign({}, defaults, opts, { particleCount: Math.floor(count * particleRatio) }));
            }
            fire(0.25, { spread: 26, startVelocity: 55 }); fire(0.2, { spread: 60 }); fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
            fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 }); fire(0.1, { spread: 120, startVelocity: 45 });
        };

        // --- BİLEŞENLER ---

        // Ses Kontrol Butonu
        const SoundToggle = () => {
            const [muted, setMuted] = useState(SoundEngine.muted);
            return (
                <button 
                    onClick={() => setMuted(SoundEngine.toggleMute())} 
                    className="p-2 rounded-full bg-slate-800/50 hover:bg-slate-700/80 text-slate-400 hover:text-white transition-all backdrop-blur-sm border border-white/10"
                    title={muted ? "Sesi Aç" : "Sesi Kapat"}
                >
                    {muted ? <VolumeX className="w-5 h-5" /> : <Volume2 className="w-5 h-5" />}
                </button>
            );
        };

        // --- Host Panel ---
        const HostPanel = ({ sessionData, setSessionData, setView, connections }) => {
            const [expandedQ, setExpandedQ] = useState(null);
            const [selectedUser, setSelectedUser] = useState(null);
            const [showPodium, setShowPodium] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [hostTimer, setHostTimer] = useState(sessionData.duration);
            
            // Ref for safe interval access
            const sessionDataRef = useRef(sessionData);
            useEffect(() => { sessionDataRef.current = sessionData; }, [sessionData]);
            
            // Settings State
            const [tempDuration, setTempDuration] = useState(sessionData.duration || 60);
            const [tempSelectedQIds, setTempSelectedQIds] = useState(sessionData.questions.map(q => q.id));
            const [showAdvancedSelection, setShowAdvancedSelection] = useState(false);
            const [customQuestions, setCustomQuestions] = useState(() => {
                try {
                    const saved = localStorage.getItem('gemini_quiz_custom_questions');
                    return saved ? JSON.parse(saved) : [];
                } catch (e) {
                    return [];
                }
            });
            const [showCustomQForm, setShowCustomQForm] = useState(false);
            const [newQ, setNewQ] = useState({ text: '', options: ['', '', '', ''], correct: 0 });

            useEffect(() => { localStorage.setItem('gemini_quiz_custom_questions', JSON.stringify(customQuestions)); }, [customQuestions]);

            // Timer
            useEffect(() => {
                let interval;
                if (sessionData.status === 'active' && sessionData.startTime) {
                    // Eğer süre "Sınırsız" ise (>= threshold), zamanlayıcı geri saymaz veya bitmez
                    if (sessionData.duration >= UNLIMITED_DURATION_THRESHOLD) {
                        setHostTimer(UNLIMITED_DURATION_THRESHOLD); // UI için sınırsız flag
                    } else {
                        interval = setInterval(() => {
                            const elapsed = Math.floor((Date.now() - sessionData.startTime) / 1000);
                            const remaining = Math.max(0, sessionData.duration - elapsed);
                            setHostTimer(remaining);
                            if (remaining === 0) { 
                                clearInterval(interval); 
                                broadcastUpdate({ ...sessionDataRef.current, status: 'finished' }); 
                            }
                        }, 1000);
                    }
                } else { setHostTimer(sessionData.duration); }
                return () => clearInterval(interval);
            }, [sessionData.status, sessionData.startTime, sessionData.duration]);

            const stats = useMemo(() => {
                if (!sessionData?.participants) return null;
                const sorted = [...sessionData.participants].sort((a, b) => b.score - a.score);
                const total = sessionData.participants.length;

                const qStats = sessionData.questions.map(q => {
                    const counts = new Array(q.options.length).fill(0);
                    let correctCount = 0;
                    let answered = 0;
                    sessionData.participants.forEach(p => {
                        const ans = p.answers[q.id];
                        if (typeof ans === 'number') {
                            counts[ans]++;
                            answered++;
                        }
                        if (ans === q.correct) correctCount++;
                    });
                    return { ...q, counts, correctCount, wrong: answered - correctCount, total, answered };
                });

                const finishedCount = sessionData.participants.filter(p => p.isFinished).length;
                return { sorted, qStats, total, finishedCount };
            }, [sessionData]);

            useEffect(() => {
                if (sessionData.status === 'finished') {
                    triggerConfetti();
                    SoundEngine.play('victory');
                    setShowPodium(true);
                    setTimeout(() => setShowPodium(false), 10000);
                }
            }, [sessionData.status]);

            // Auto Finish
            useEffect(() => {
                if (sessionData.status === 'active' && sessionData.participants?.length > 0) {
                    if (sessionData.participants.every(p => p.isFinished)) {
                        setTimeout(() => broadcastUpdate({ ...sessionData, status: 'finished' }), 1000);
                    }
                }
            }, [sessionData]);

            const broadcastUpdate = (newData) => {
                setSessionData(newData);
                window.currentQuizStatus = newData.status;
                if (connections.current) connections.current.forEach(conn => { if (conn.open) conn.send({ type: 'UPDATE', data: newData }); });
            };

            const startQuiz = () => { SoundEngine.play('start'); broadcastUpdate({ ...sessionData, status: 'active', startTime: Date.now() }); };
            const endQuiz = () => { broadcastUpdate({ ...sessionData, status: 'finished' }); };
            
            const restartQuiz = () => {
                SoundEngine.play('host_create'); 
                setShowPodium(false);
                const count = sessionData.questions.length;
                const allPool = [...QUESTION_POOL, ...customQuestions];
                const shuffled = [...allPool].sort(() => 0.5 - Math.random());
                const newQuestions = shuffled.slice(0, count);
                setTempSelectedQIds(newQuestions.map(q => q.id));

                const resetParticipants = sessionData.participants.map(p => ({ ...p, score: 0, answers: {}, isFinished: false }));
                broadcastUpdate({ 
                    ...sessionData, 
                    status: 'waiting', 
                    participants: resetParticipants, 
                    startTime: null,
                    questions: newQuestions
                });
            };
            
            const goHome = () => { if(confirm("Oturum kapatılacak?")) window.location.reload(); };

            const addCustomQuestion = () => {
                if (!newQ.text || newQ.options.some(o => !o)) return alert("Eksik bilgi.");
                const q = { ...newQ, id: 'cust_' + Date.now() };
                setCustomQuestions([...customQuestions, q]);
                setTempSelectedQIds([...tempSelectedQIds, q.id]);
                setNewQ({ text: '', options: ['', '', '', ''], correct: 0 });
                setShowCustomQForm(false);
                SoundEngine.play('click');
            };

            const deleteCustomQuestion = (id) => {
                setCustomQuestions(customQuestions.filter(q => q.id !== id));
                setTempSelectedQIds(tempSelectedQIds.filter(qid => qid !== id));
            };

            const saveSettings = () => {
                const allPool = [...QUESTION_POOL, ...customQuestions];
                const selectedQuestions = allPool.filter(q => tempSelectedQIds.includes(q.id));
                if (selectedQuestions.length === 0) return alert("Soru seçmelisiniz!");
                broadcastUpdate({ ...sessionData, duration: tempDuration, questions: selectedQuestions });
                setShowSettings(false);
                SoundEngine.play('click');
            };
            
            const toggleQuestionSelection = (id) => {
                setTempSelectedQIds(prev => {
                    if (prev.includes(id)) return prev.filter(qId => qId !== id);
                    return [...prev, id];
                });
            };

            // Canlı Sıralama Analiz Butonu Mantığı
            const isRankClickable = sessionData.status === 'active' || sessionData.status === 'finished';

            return (
                <div className="flex flex-col h-full border-r border-slate-800">
                    {/* Header */}
                    <div className="flex justify-between items-center px-6 py-5 border-b border-white/5 bg-slate-900/50 backdrop-blur-md shrink-0">
                        <div>
                            <h2 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400 flex items-center gap-3 tracking-tighter italic pr-2">
                                <Brain className="text-indigo-400 w-8 h-8 flex-shrink-0" /> ASRIN PANELİ
                            </h2>
                            <p className="text-xs text-slate-400 font-bold uppercase tracking-widest mt-1 flex items-center gap-2">
                                <span className="w-2 h-2 rounded-full animate-pulse bg-emerald-500 shadow-[0_0_10px_#10b981]"></span> CANLI SUNUCU
                            </p>
                        </div>
                        <div className="flex items-center gap-4">
                            <button onClick={goHome} className="p-2 rounded-full bg-slate-800/50 hover:bg-red-500/20 text-slate-400 hover:text-red-400 transition-all backdrop-blur-sm border border-white/10" title="Oturumu Kapat">
                                <LogOut className="w-5 h-5" />
                            </button>
                            {sessionData.status === 'active' && (
                                <div className="flex items-center gap-2 glass-panel px-4 py-2 rounded-full border border-red-500/30 shadow-[0_0_15px_rgba(239,68,68,0.2)] animate-pulse">
                                    <Clock className="w-5 h-5 text-red-400" />
                                    <span className="font-mono font-black text-red-100 text-xl text-center min-w-[3rem]">
                                        {formatTime(hostTimer)}
                                    </span>
                                </div>
                            )}
                            <SoundToggle />
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-6 pb-24">
                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                            
                            {/* Sol Kolon */}
                            <div className="lg:col-span-4 flex flex-col gap-6">
                                <div className="glass-panel p-6 rounded-3xl relative overflow-hidden group">
                                    <div className="absolute -right-6 -top-6 p-6 opacity-5 rotate-12 transition-transform group-hover:scale-110 duration-700"><Wifi className="w-32 h-32 text-white" /></div>
                                    <div className="relative z-10">
                                        <h3 className="text-xs font-black text-slate-400 mb-6 uppercase tracking-widest border-b border-white/5 pb-2">Kontrol Merkezi</h3>
                                        
                                        <div className="grid grid-cols-2 gap-4 mb-6">
                                            <div className="bg-slate-800/40 p-4 rounded-2xl border border-white/5 text-center">
                                                <div className="text-3xl font-black text-white">{sessionData.participants?.length || 0}</div>
                                                <div className="text-[10px] font-bold text-slate-500 uppercase mt-1">Bağlı</div>
                                            </div>
                                            <div className="bg-slate-800/40 p-4 rounded-2xl border border-white/5 text-center">
                                                <div className={`text-3xl font-black ${stats.finishedCount === stats.total && stats.total > 0 ? 'text-emerald-400' : 'text-indigo-400'}`}>
                                                    {stats.finishedCount}<span className="text-slate-600 text-lg">/{stats.total}</span>
                                                </div>
                                                <div className="text-[10px] font-bold text-slate-500 uppercase mt-1">Tamamlayan</div>
                                            </div>
                                        </div>

                                        <div className="space-y-3">
                                            {sessionData.status === 'waiting' && (
                                                <>
                                                    <button onClick={startQuiz} className="w-full bg-gradient-to-r from-emerald-600 to-teal-500 hover:from-emerald-500 hover:to-teal-400 py-4 rounded-xl font-bold text-white flex items-center justify-center gap-2 shadow-lg shadow-emerald-900/40 hover:scale-[1.02] active:scale-[0.98] transition-all"><Play className="w-5 h-5 fill-current" /> BAŞLAT</button>
                                                    <button onClick={() => { setShowSettings(true); setTempDuration(sessionData.duration); setTempSelectedQIds(sessionData.questions.map(q => q.id)); }} className="w-full bg-slate-800 hover:bg-slate-700 py-3 rounded-xl font-bold text-slate-300 flex items-center justify-center gap-2 transition-all border border-slate-700 hover:border-slate-600"><Settings className="w-4 h-4" /> AYARLAR & SORULAR</button>
                                                </>
                                            )}
                                            {sessionData.status === 'active' && <button onClick={endQuiz} className="w-full bg-gradient-to-r from-rose-600 to-red-500 py-4 rounded-xl font-bold text-white flex items-center justify-center gap-2 shadow-lg shadow-red-900/40 hover:scale-[1.02] active:scale-[0.98] transition-all"><LogOut className="w-5 h-5" /> BİTİR</button>}
                                            {sessionData.status === 'finished' && (
                                                <div className="grid grid-cols-2 gap-3">
                                                    <button onClick={restartQuiz} className="w-full bg-indigo-600 hover:bg-indigo-500 py-3 rounded-xl font-bold text-white flex items-center justify-center gap-2 transition-all"><RotateCcw className="w-4 h-4" /> YENİDEN</button>
                                                    <button onClick={goHome} className="w-full bg-slate-800 hover:bg-slate-700 py-3 rounded-xl font-bold text-slate-300 flex items-center justify-center gap-2 transition-all"><Home className="w-4 h-4" /> ÇIKIŞ</button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                <div className="glass-panel p-6 rounded-3xl flex-1 flex flex-col min-h-[300px]">
                                    <h3 className="text-xs font-black text-slate-400 mb-4 uppercase tracking-widest border-b border-white/5 pb-2 flex items-center gap-2">
                                        <Trophy className="w-4 h-4 text-yellow-500" /> Canlı Sıralama
                                    </h3>
                                    <div className="space-y-2 overflow-y-auto pr-1 flex-1 custom-scrollbar">
                                        {stats?.sorted.map((p, i) => (
                                            <div key={i} 
                                                onClick={() => {
                                                    if (isRankClickable) {
                                                        SoundEngine.play('click'); 
                                                        setSelectedUser(p);
                                                    }
                                                }} 
                                                className={`p-3 rounded-xl flex justify-between items-center transition-all border border-transparent group ${p.isFinished ? 'bg-emerald-500/10' : 'bg-slate-800/40'} ${isRankClickable ? 'cursor-pointer hover:border-white/10' : 'cursor-default'}`}
                                            >
                                                <div className="flex items-center gap-3">
                                                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center text-xs font-black shadow-lg ${i===0?'bg-yellow-400 text-black':i===1?'bg-slate-300 text-black':i===2?'bg-orange-400 text-black':'bg-slate-700 text-slate-400'}`}>{i+1}</div>
                                                    <div className="flex flex-col">
                                                        <span className="font-bold text-sm text-slate-200 group-hover:text-white truncate max-w-[120px] flex items-center gap-2">
                                                            {p.username}
                                                            {isRankClickable && <span className="text-[8px] bg-indigo-500/20 text-indigo-300 border border-indigo-500/20 px-1 py-0.5 rounded uppercase tracking-wider font-bold">Analizi Gör</span>}
                                                        </span>
                                                        {p.isFinished && <span className="text-[9px] text-emerald-400 font-bold uppercase tracking-wider">Tamamladı</span>}
                                                    </div>
                                                </div>
                                                <span className="font-black text-white text-lg">{p.score}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* Sağ Kolon */}
                            <div className="lg:col-span-8 glass-panel p-6 rounded-3xl flex flex-col h-full min-h-[500px]">
                                <h3 className="text-xs font-black text-slate-400 mb-6 uppercase tracking-widest border-b border-white/5 pb-2 flex items-center gap-2">
                                    <BarChart2 className="w-4 h-4 text-indigo-400" /> Soru Analizi
                                </h3>
                                <div className="space-y-4 overflow-y-auto pr-2 flex-1">
                                    {stats?.qStats.map((q, i) => {
                                        const successRate = q.answered > 0 ? Math.round((q.correctCount / q.answered) * 100) : 0;
                                        const barCorrect = q.total > 0 ? (q.correctCount / q.total) * 100 : 0;
                                        const barWrong = q.total > 0 ? (q.wrong / q.total) * 100 : 0;

                                        return (
                                            <div key={i} className="bg-slate-900/40 rounded-2xl border border-white/5 overflow-hidden transition-all hover:bg-slate-800/40 group">
                                                <button onClick={() => { SoundEngine.play('click'); setExpandedQ(expandedQ === i ? null : i); }} className="w-full text-left p-5 flex justify-between items-center gap-4">
                                                    <div className="flex-1">
                                                        <div className="flex items-center gap-3 mb-3">
                                                            <span className="bg-indigo-500/10 border border-indigo-500/20 text-indigo-300 text-[10px] px-2 py-0.5 rounded font-black uppercase tracking-wider">#{i+1}</span>
                                                            {q.answered > 0 && <span className={`text-[10px] px-2 py-0.5 rounded font-black uppercase tracking-wider ${successRate >= 50 ? 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20' : 'bg-rose-500/10 text-rose-400 border border-rose-500/20'}`}>%{successRate} Doğru</span>}
                                                        </div>
                                                        <p className="text-sm font-medium text-slate-200 leading-relaxed mb-4 pl-1 text-wrap">{q.text}</p>
                                                        <div className="flex h-1.5 w-full rounded-full overflow-hidden bg-slate-950 shadow-inner">
                                                            <div className="bg-emerald-500 h-full transition-all duration-700" style={{width: `${barCorrect}%`}} />
                                                            <div className="bg-rose-500 h-full transition-all duration-700" style={{width: `${barWrong}%`}} />
                                                        </div>
                                                    </div>
                                                    <div className={`p-2 rounded-full transition-transform duration-300 bg-slate-950 border border-white/5 ${expandedQ === i ? 'rotate-180 text-white' : 'text-slate-500'}`}><ChevronDown className="w-4 h-4" /></div>
                                                </button>
                                                
                                                {expandedQ === i && (
                                                    <div className="px-5 pb-5 pt-2 animate-enter space-y-2">
                                                        {q.options.map((opt, idx) => {
                                                            const count = q.counts[idx];
                                                            const perc = ((count/q.total)*100 || 0).toFixed(0);
                                                            const isCorrect = idx === q.correct;
                                                            const showTick = isCorrect && sessionData.status === 'finished';
                                                            
                                                            return (
                                                                <div key={idx} className={`relative h-auto min-h-[44px] w-full rounded-lg overflow-hidden flex items-center border ${showTick ? 'bg-emerald-900/10 border-emerald-500/20' : 'bg-slate-950/30 border-white/5'}`}>
                                                                    <div className={`absolute inset-y-0 left-0 transition-all duration-1000 opacity-20 ${showTick ? 'bg-emerald-500' : 'bg-indigo-500'}`} style={{width: `${perc}%`}} />
                                                                    <div className="relative z-10 w-full flex justify-between items-center px-4 py-2 text-xs">
                                                                        <div className="flex items-center gap-2 flex-1 pr-2">
                                                                            <span className={`font-medium break-words ${showTick ? 'text-emerald-400' : 'text-slate-400'}`}>{opt}</span>
                                                                            {showTick && <CheckCircle className="w-3 h-3 text-emerald-500 flex-shrink-0" />}
                                                                        </div>
                                                                        <div className="flex items-center gap-2 bg-slate-900/80 px-2 py-1 rounded-md border border-white/5 shadow-sm">
                                                                            <span className="font-mono font-bold text-slate-500">{count} Kişi</span>
                                                                            <span className="text-[10px] text-slate-600 border-l border-slate-700 pl-2">%{perc}</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            )
                                                        })}
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Ayarlar ve Modallar */}
                    {showSettings && (
                        <div className="fixed inset-0 z-[70] flex items-center justify-center bg-slate-950/80 backdrop-blur-md p-4 animate-fade-in" onClick={() => setShowSettings(false)}>
                            <div className="glass-panel w-full max-w-xl rounded-[2rem] shadow-2xl flex flex-col max-h-[85vh] overflow-hidden" onClick={e => e.stopPropagation()}>
                                <div className="p-6 border-b border-white/5 flex justify-between items-center">
                                    <h3 className="font-black text-xl text-white flex items-center gap-2"><Settings className="w-5 h-5 text-indigo-400" /> AYARLAR</h3>
                                    <button onClick={() => setShowSettings(false)} className="p-2 hover:bg-white/10 rounded-full transition-colors"><XCircle className="w-5 h-5" /></button>
                                </div>
                                <div className="p-6 overflow-y-auto space-y-8">
                                    
                                    {/* Süre Ayarı */}
                                    <div className="space-y-4">
                                        <div className="flex justify-between items-center">
                                            <label className="text-sm font-bold text-slate-300 flex items-center gap-2"><Clock className="w-4 h-4 text-indigo-400"/> Süre</label>
                                            <span className="text-indigo-300 font-mono font-black text-lg bg-indigo-500/10 px-3 py-1 rounded-lg border border-indigo-500/20 min-w-[6rem] text-center inline-block">
                                                {formatTime(tempDuration)}
                                            </span>
                                        </div>
                                        <input 
                                            type="range" 
                                            min="30" 
                                            max={UNLIMITED_DURATION_THRESHOLD} 
                                            step="30" 
                                            value={tempDuration} 
                                            onChange={(e) => setTempDuration(Number(e.target.value))} 
                                            className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-indigo-500" 
                                        />
                                        <div className="flex justify-between text-[10px] text-slate-600 font-bold uppercase">
                                            <span>30sn</span>
                                            <span>Sınırsız</span>
                                        </div>
                                    </div>
                                    
                                    <hr className="border-white/5" />
                                    
                                    {/* Soru Sayısı Ayarı */}
                                    <div className="space-y-4">
                                        <div className="flex justify-between items-center">
                                            <label className="text-sm font-bold text-slate-300 flex items-center gap-2"><Settings className="w-4 h-4 text-orange-400"/> Soru Sayısı</label>
                                            <span className="text-orange-300 font-mono font-black text-lg bg-orange-500/10 px-3 py-1 rounded-lg border border-orange-500/20">{tempSelectedQIds.length} Soru</span>
                                        </div>
                                        <input 
                                            type="range" 
                                            min="1" 
                                            max={QUESTION_POOL.length + customQuestions.length} 
                                            step="1" 
                                            value={tempSelectedQIds.length} 
                                            onChange={(e) => {
                                                const count = Number(e.target.value);
                                                const allPool = [...QUESTION_POOL, ...customQuestions];
                                                const shuffled = [...allPool].sort(() => 0.5 - Math.random());
                                                setTempSelectedQIds(shuffled.slice(0, count).map(q => q.id));
                                            }} 
                                            className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-orange-500" 
                                        />
                                        <div className="bg-slate-800/50 p-3 rounded-xl border border-white/5 flex flex-col gap-2">
                                            <p className="text-[10px] text-slate-400 flex items-center gap-2 italic">
                                                <Info className="w-3 h-3" /> Bar her kaydırıldığında sorular rastgele seçilir.
                                            </p>
                                            <div className="flex gap-2">
                                                <div className="flex-1 bg-indigo-500/10 border border-indigo-500/20 rounded-lg p-2 text-center">
                                                    <span className="block text-[10px] text-indigo-300 uppercase font-bold">Asrın Soruları</span>
                                                    <span className="block text-lg font-black text-white">
                                                        {tempSelectedQIds.filter(id => customQuestions.map(q=>q.id).includes(id)).length}
                                                    </span>
                                                </div>
                                                <div className="flex-1 bg-slate-700/30 border border-slate-600/30 rounded-lg p-2 text-center">
                                                    <span className="block text-[10px] text-slate-400 uppercase font-bold">Genel Havuz</span>
                                                    <span className="block text-lg font-black text-white">
                                                        {tempSelectedQIds.filter(id => QUESTION_POOL.map(q=>q.id).includes(id)).length}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <hr className="border-white/5" />
                                    
                                    <div className="space-y-4">
                                        <button onClick={() => setShowAdvancedSelection(!showAdvancedSelection)} className="w-full flex justify-between items-center text-sm font-bold text-slate-300 hover:text-white transition-colors bg-slate-800/40 p-4 rounded-xl border border-white/5"><span className="flex items-center gap-2"><List className="w-4 h-4 text-emerald-400"/> Gelişmiş / Özel Sorular</span>{showAdvancedSelection ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}</button>
                                        {showAdvancedSelection && (
                                            <div className="space-y-6 animate-enter">
                                                <div className="bg-slate-800/20 p-4 rounded-xl border border-white/5">
                                                    <div className="flex justify-between items-center mb-4"><h4 className="text-xs font-bold text-indigo-400 uppercase tracking-widest">ASRIN SORULARI</h4><div className="flex items-center gap-2"><span className="text-[10px] bg-indigo-500/20 text-indigo-300 px-2 py-0.5 rounded border border-indigo-500/30">{tempSelectedQIds.filter(id => customQuestions.map(q=>q.id).includes(id)).length} Seçildi</span><button onClick={() => setShowCustomQForm(!showCustomQForm)} className="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold flex items-center gap-1 transition-colors"><Plus className="w-3 h-3" /> YENİ EKLE</button></div></div>
                                                    {showCustomQForm && (
                                                        <div className="space-y-3 mb-4 bg-slate-950/50 p-4 rounded-xl border border-indigo-500/30 animate-enter">
                                                            <input type="text" placeholder="Soru metni..." className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-sm text-white focus:border-indigo-500 outline-none" value={newQ.text} onChange={(e) => setNewQ({...newQ, text: e.target.value})} />
                                                            <div className="grid grid-cols-2 gap-2">{newQ.options.map((opt, i) => (<div key={i} className="flex items-center gap-2"><input type="radio" name="correctOption" checked={newQ.correct === i} onChange={() => setNewQ({...newQ, correct: i})} className="accent-emerald-500 w-4 h-4" /><input type="text" placeholder={`Şık ${i+1}`} className="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-xs text-white focus:border-indigo-500 outline-none" value={opt} onChange={(e) => { const newOpts = [...newQ.options]; newOpts[i] = e.target.value; setNewQ({...newQ, options: newOpts}); }} /></div>))}</div>
                                                            <button onClick={addCustomQuestion} className="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-2 rounded-lg text-xs font-bold mt-2 shadow-lg shadow-emerald-900/20">KAYDET</button>
                                                        </div>
                                                    )}
                                                    {customQuestions.length > 0 ? (<div className="space-y-2">{customQuestions.map(q => { const isSelected = tempSelectedQIds.includes(q.id); return (<div key={q.id} className={`p-3 rounded-lg border flex items-center justify-between gap-3 transition-colors ${isSelected ? 'bg-indigo-500/10 border-indigo-500/30' : 'bg-slate-900/30 border-white/5'}`}><div className="flex items-center gap-3 cursor-pointer flex-1" onClick={() => toggleQuestionSelection(q.id)}>{isSelected ? <CheckSquare className="w-4 h-4 text-indigo-400 shrink-0" /> : <Square className="w-4 h-4 text-slate-600 shrink-0" />}<span className={`text-xs font-medium ${isSelected ? 'text-white' : 'text-slate-500'}`}>{q.text}</span></div><button onClick={() => deleteCustomQuestion(q.id)} className="text-slate-600 hover:text-red-400 p-1"><Trash2 className="w-3.5 h-3.5" /></button></div>)})}</div>) : (<p className="text-[10px] text-slate-600 italic text-center py-2">Henüz soru eklenmedi.</p>)}
                                                </div>
                                                <div>
                                                    <div className="flex justify-between items-center mb-2"><h4 className="text-xs font-bold text-slate-500 uppercase tracking-widest">Genel Soru Havuzu</h4><span className="text-[10px] bg-slate-800 px-2 py-0.5 rounded text-slate-400">{tempSelectedQIds.filter(id => QUESTION_POOL.map(q=>q.id).includes(id)).length} Seçildi</span></div>
                                                    <div className="grid grid-cols-1 gap-2 max-h-[300px] overflow-y-auto pr-2">{QUESTION_POOL.map(q => { const isSelected = tempSelectedQIds.includes(q.id); return (<div key={q.id} onClick={() => toggleQuestionSelection(q.id)} className={`p-4 rounded-xl border cursor-pointer transition-all flex items-start gap-3 group ${isSelected ? 'bg-indigo-500/10 border-indigo-500/30' : 'bg-slate-900/30 border-white/5'}`}><div className={`mt-0.5 ${isSelected ? 'text-indigo-400' : 'text-slate-600'}`}>{isSelected ? <CheckSquare className="w-5 h-5" /> : <Square className="w-5 h-5" />}</div><span className={`text-sm font-medium ${isSelected ? 'text-slate-200' : 'text-slate-500'}`}>{q.text}</span></div>); })}</div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <div className="p-6 border-t border-white/5 bg-slate-900/30"><button onClick={saveSettings} className="w-full bg-emerald-600 hover:bg-emerald-500 py-3 rounded-xl font-bold text-white transition-all shadow-lg shadow-emerald-900/20 active:scale-95 flex items-center justify-center gap-2"><Save className="w-4 h-4" /> AYARLARI UYGULA</button></div>
                            </div>
                        </div>
                    )}
                    
                    {showPodium && stats.sorted.length >= 1 && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-slate-950/90 backdrop-blur-xl p-4 animate-scale-in" onClick={() => setShowPodium(false)}>
                            <div className="w-full max-w-5xl relative" onClick={e => e.stopPropagation()}>
                                <button onClick={() => setShowPodium(false)} className="absolute -top-12 right-0 p-2 hover:bg-white/10 rounded-full text-slate-400 hover:text-white transition-colors"><XCircle className="w-8 h-8" /></button>
                                <div className="flex flex-col items-center justify-center h-full">
                                    <div className="flex items-end justify-center gap-4 md:gap-8 pb-10 min-h-[400px] mt-16">
                                        {/* Podyum Öğeleri (Aynı) */}
                                        {stats.sorted[1] && (<div className="flex flex-col items-center w-1/3 animate-enter" style={{animationDelay: '0.2s'}}><div className="mb-4 text-center"><span className="block font-bold text-slate-200 text-lg md:text-2xl mb-1">{stats.sorted[1].username}</span><span className="block font-mono text-slate-400 font-bold">{stats.sorted[1].score} P</span></div><div className="w-20 md:w-32 bg-gradient-to-t from-slate-600 to-slate-400 h-32 md:h-48 rounded-t-2xl shadow-2xl flex items-start justify-center pt-4 border-t-4 border-slate-300 relative group"><span className="text-5xl font-black text-slate-800/50">2</span></div></div>)}
                                        {stats.sorted[0] && (<div className="flex flex-col items-center w-1/3 animate-enter relative z-10 -mt-12" style={{animationDelay: '0s'}}><div className="absolute -top-24 animate-bounce-short"><Crown className="w-24 h-24 text-yellow-400 fill-yellow-400 drop-shadow-[0_0_30px_rgba(250,204,21,0.8)]" /></div><div className="mb-4 text-center"><span className="block font-black text-yellow-400 text-2xl md:text-4xl drop-shadow-md mb-2">{stats.sorted[0].username}</span><span className="block font-mono text-yellow-200 text-lg font-bold bg-yellow-500/20 px-3 py-1 rounded-full">{stats.sorted[0].score} P</span></div><div className="w-24 md:w-40 bg-gradient-to-t from-yellow-600 to-yellow-400 h-48 md:h-64 rounded-t-2xl shadow-[0_0_50px_rgba(234,179,8,0.4)] flex items-start justify-center pt-6 border-t-4 border-yellow-100 relative group"><span className="text-6xl font-black text-yellow-800/50">1</span></div></div>)}
                                        {stats.sorted[2] && (<div className="flex flex-col items-center w-1/3 animate-enter" style={{animationDelay: '0.4s'}}><div className="mb-4 text-center"><span className="block font-bold text-orange-200 text-lg md:text-2xl mb-1">{stats.sorted[2].username}</span><span className="block font-mono text-orange-400 font-bold">{stats.sorted[2].score} P</span></div><div className="w-full bg-gradient-to-b from-orange-500 to-orange-700 h-32 rounded-t-3xl shadow-[0_0_40px_rgba(249,115,22,0.3)] flex items-start justify-center pt-4 border-t-4 border-orange-300 relative"><span className="text-6xl font-black text-orange-900/30">3</span></div></div>)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Kullanıcı Detay Modalı */}
                    {selectedUser && (
                        <div className="fixed inset-0 z-50 bg-slate-950/80 backdrop-blur-md flex items-center justify-center p-4 animate-scale-in" onClick={() => setSelectedUser(null)}>
                            <div className="glass-panel w-full max-w-md rounded-[2rem] shadow-2xl flex flex-col max-h-[80vh] overflow-hidden" onClick={e => e.stopPropagation()}>
                                <div className="p-6 border-b border-white/5 flex justify-between items-center bg-slate-900/30">
                                    <div>
                                        <h3 className="font-black text-xl text-white">{selectedUser.username}</h3>
                                        {selectedUser.isFinished && selectedUser.completionTime !== undefined && (
                                            <div className="flex items-center gap-2 mt-1">
                                                <Clock className="w-3 h-3 text-emerald-400" />
                                                <span className="text-xs font-mono text-emerald-400 font-bold">
                                                    Tamamlama: {formatTime(selectedUser.completionTime)}
                                                </span>
                                            </div>
                                        )}
                                    </div>
                                    <button onClick={() => setSelectedUser(null)} className="p-2 hover:bg-white/10 rounded-full transition-colors"><XCircle /></button>
                                </div>
                                <div className="p-6 overflow-y-auto space-y-4">{sessionData.questions.map((q, i) => { const uAns = selectedUser.answers[q.id]; const isCorr = uAns === q.correct; return (<div key={i} className={`p-4 rounded-2xl border transition-all ${isCorr ? 'bg-emerald-500/5 border-emerald-500/20' : 'bg-rose-500/5 border-rose-500/20'}`}><div className="flex gap-3 mb-2"><span className={`text-[10px] font-black px-2 py-0.5 rounded h-fit ${isCorr ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'}`}>#{i+1}</span><p className="text-sm font-bold text-slate-200 leading-relaxed">{q.text}</p></div><div className="text-xs space-y-1 pl-10"><div className={`flex items-center gap-2 font-medium ${isCorr ? 'text-emerald-400' : 'text-red-400'}`}>{isCorr ? <CheckCircle className="w-3 h-3" /> : <XCircle className="w-3 h-3" />}<span>{q.options[uAns] || 'Boş bırakıldı'}</span></div></div></div>)})}</div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Participant Panel ---
        const ParticipantPanel = ({ initialUsername, sessionData, conn, onSimulateSubmit }) => {
            const [curIdx, setCurIdx] = useState(0);
            const [answers, setAnswers] = useState({});
            const [submitted, setSubmitted] = useState(false);
            const [timer, setTimer] = useState(sessionData.duration || 60);
            
            // YENİ: Feedback state
            const [showFeedback, setShowFeedback] = useState(false);
            const [feedbackStatus, setFeedbackStatus] = useState(null); // 'correct' | 'wrong'

            const answersRef = useRef({}); 
            const sessionDataRef = useRef(sessionData); 
            const submittedRef = useRef(false);

            useEffect(() => {
                sessionDataRef.current = sessionData;
                const myServerData = sessionData.participants?.find(p => p.username === initialUsername);
                if (myServerData && myServerData.answers && Object.keys(answersRef.current).length === 0 && Object.keys(myServerData.answers).length > 0) {
                    answersRef.current = myServerData.answers;
                    setAnswers(myServerData.answers);
                }
            }, [sessionData, initialUsername]);

            const sendProgress = (newAnswers, isFinal = false, timeSpent = null) => {
                let currentScore = 0;
                const currentQuestions = sessionDataRef.current.questions || [];
                
                currentQuestions.forEach(q => { 
                    if (newAnswers[q.id] === q.correct) currentScore += 10; 
                });
                
                const payload = { 
                    username: initialUsername, 
                    score: currentScore, 
                    answers: newAnswers, 
                    isFinished: isFinal,
                    completionTime: timeSpent 
                };
                if (conn && conn.open) conn.send({ type: 'PROGRESS', payload });
            };

            const handleAnswer = (qId, optionIdx) => {
                if (showFeedback) return; // Cevap gösterilirken tıklamayı engelle
                
                // 1. Cevabı Kaydet
                const newAnswers = { ...answersRef.current, [qId]: optionIdx };
                answersRef.current = newAnswers; 
                setAnswers(newAnswers); 

                // 2. Ses ve Efekt
                const currentQ = sessionData.questions[curIdx];
                const isCorrect = optionIdx === currentQ.correct;
                if (isCorrect) SoundEngine.play('correct_answer'); // YENİ: Farklı doğru cevap sesi
                else SoundEngine.play('error');

                // 3. Puanı ANINDA Gönder (Otomatik)
                sendProgress(newAnswers, false);

                // 4. Feedback Modunu Aç ve Otomatik İlerle
                setFeedbackStatus(isCorrect ? 'correct' : 'wrong');
                setShowFeedback(true);

                // 5. 1 Saniye Sonra Geç
                setTimeout(() => {
                    setShowFeedback(false);
                    if (curIdx < sessionData.questions.length - 1) {
                        setCurIdx(curIdx + 1);
                    } else {
                        finish();
                    }
                }, 1000); 
            };

            useEffect(() => {
                if (sessionData.status === 'waiting') {
                    setSubmitted(false);
                    submittedRef.current = false;
                    setAnswers({});
                    answersRef.current = {}; 
                    setCurIdx(0);
                    setTimer(sessionData.duration || 60);
                }
            }, [sessionData.status, sessionData.duration]);

            useEffect(() => {
                if (sessionData.status === 'active' && !submitted && timer > 0 && sessionData.startTime) {
                    // Sınırsız mod kontrolü
                    if (sessionData.duration >= UNLIMITED_DURATION_THRESHOLD) {
                        // Sınırsızsa geri sayım yok
                    } else {
                        const t = setInterval(() => {
                            const elapsed = Math.floor((Date.now() - sessionData.startTime) / 1000);
                            const remaining = Math.max(0, sessionData.duration - elapsed);
                            setTimer(remaining);
                            if (remaining === 0) finish();
                        }, 1000);
                        return () => clearInterval(t);
                    }
                }
            }, [timer, sessionData.status, submitted, sessionData.startTime, sessionData.duration]); 

            useEffect(() => {
                if (sessionData.status === 'finished') {
                    const results = [...(sessionData.participants || [])].sort((a,b) => b.score - a.score);
                    const myRank = results.findIndex(p => p.username === initialUsername) + 1;
                    
                    if (myRank > 0 && myRank <= 3) {
                        triggerConfetti();
                        setTimeout(() => SoundEngine.play('victory'), 500); 
                    } else {
                        SoundEngine.play('finish');
                    }
                }
            }, [sessionData.status]);

            const finish = () => {
                if (submittedRef.current) return; 
                submittedRef.current = true;
                setSubmitted(true);

                let timeSpent = 0;
                if (sessionData.duration >= UNLIMITED_DURATION_THRESHOLD) {
                     // Sınırsız modda geçen süre
                     timeSpent = Math.floor((Date.now() - sessionData.startTime) / 1000);
                } else {
                     // Sınırlı modda harcanan süre
                     timeSpent = sessionData.duration - timer;
                }

                sendProgress(answersRef.current, true, timeSpent); 
            };

            const exitQuiz = () => {
                if(confirm("Yarışmadan ayrılmak istediğine emin misin?")) window.location.reload();
            };

            if (sessionData.status === 'waiting') {
                return (
                    <div className="h-full flex flex-col items-center justify-center p-8 text-center animate-fade-in relative">
                        <button onClick={exitQuiz} className="absolute top-6 right-6 p-2 rounded-full hover:bg-white/10 text-slate-400 hover:text-white transition-colors"><LogOut className="w-5 h-5"/></button>
                        <div className="w-28 h-28 bg-gradient-to-tr from-indigo-500/20 to-purple-500/20 rounded-[2.5rem] flex items-center justify-center mb-8 animate-float border border-indigo-500/30 box-shadow-xl">
                           <Wifi className="w-12 h-12 text-indigo-400" />
                        </div>
                        <h2 className="text-3xl font-black mb-3 tracking-tighter uppercase italic text-white drop-shadow-lg">Bağlanıldı!</h2>
                        <p className="text-slate-400 max-w-xs text-sm font-medium leading-relaxed mb-8">Yarışma henüz başlamadı. Ekranı açık tutun, heyecan birazdan başlıyor.</p>
                        <div className="flex gap-4">
                            <div className="glass-panel px-6 py-3 rounded-2xl text-sm text-indigo-300 font-bold shadow-lg flex items-center gap-3">
                                <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                {initialUsername}
                            </div>
                            <div className="glass-panel px-6 py-3 rounded-2xl text-sm text-indigo-300 font-bold shadow-lg flex items-center gap-2">
                                <Clock className="w-4 h-4" /> {formatTime(sessionData.duration)}
                            </div>
                        </div>
                    </div>
                );
            }

            if (sessionData.status === 'finished' || submitted) {
                const results = [...(sessionData.participants || [])].sort((a,b) => b.score - a.score);
                const score = results.find(p => p.username === initialUsername)?.score || 0;
                const rank = results.findIndex(p => p.username === initialUsername) + 1;
                const isWinner = rank <= 3 && rank > 0;

                return (
                    <div className="h-full flex flex-col items-center justify-center p-8 text-center animate-fade-in">
                        <div className={`p-8 rounded-full mb-8 border backdrop-blur-sm shadow-[0_0_50px_rgba(234,179,8,0.2)] animate-scale-in ${isWinner ? 'bg-yellow-500/20 border-yellow-500/30' : 'bg-slate-700/20 border-slate-600/30'}`}>
                            {isWinner ? <Trophy className="w-24 h-24 text-yellow-400 animate-bounce-short" /> : <Medal className="w-24 h-24 text-slate-400" />}
                        </div>
                        
                        <h2 className="text-5xl font-black mb-4 uppercase italic tracking-tighter text-white drop-shadow-xl">
                            {isWinner ? 'TEBRİKLER!' : 'BİTTİ!'}
                        </h2>
                        
                        <div className="relative inline-block my-6">
                            <div className="absolute -inset-4 bg-indigo-500/30 blur-3xl rounded-full" />
                            <p className="relative text-8xl font-black text-transparent bg-clip-text bg-gradient-to-br from-white to-indigo-200 tracking-tighter drop-shadow-2xl">
                                {score}
                            </p>
                            <span className="text-xs font-bold text-indigo-300 tracking-[0.5em] uppercase block mt-2 ml-2">PUAN</span>
                        </div>
                        {rank > 0 && (
                            <div className={`px-10 py-4 rounded-2xl border font-bold shadow-2xl flex flex-col gap-1 mt-8 ${isWinner ? 'bg-indigo-900/40 border-indigo-500/30' : 'bg-slate-800/80 border-white/10'}`}>
                                <span className="text-[10px] text-slate-400 uppercase tracking-widest">Sıralama</span>
                                <span className={`text-3xl ${rank === 1 ? 'text-yellow-400' : rank === 2 ? 'text-slate-300' : rank === 3 ? 'text-orange-400' : 'text-indigo-400'}`}>#{rank}</span>
                            </div>
                        )}
                        {submitted && sessionData.status !== 'finished' && <p className="mt-8 text-[10px] text-slate-500 font-bold uppercase tracking-widest animate-pulse">Diğer yarışmacılar bekleniyor...</p>}
                        
                        <button onClick={exitQuiz} className="mt-12 px-8 py-4 rounded-2xl bg-white/5 hover:bg-white/10 border border-white/5 text-slate-400 hover:text-white transition-all text-xs font-bold flex items-center gap-2"><LogOut className="w-4 h-4"/> ÇIKIŞ YAP</button>
                    </div>
                );
            }

            const q = sessionData.questions[curIdx];

            return (
                <div className="h-full flex flex-col animate-fade-in">
                    <div className="h-1.5 bg-slate-800/50 w-full"><div className="h-full bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 transition-all duration-700 shadow-[0_0_15px_rgba(99,102,241,0.6)]" style={{width: `${((curIdx+1)/sessionData.questions.length)*100}%`}} /></div>
                    <div className="flex-1 p-6 flex flex-col max-w-xl mx-auto w-full pb-20 overflow-y-auto">
                        <div className="flex justify-between items-center mb-8">
                            <span className="bg-slate-800/80 backdrop-blur px-4 py-1.5 rounded-xl text-[10px] font-black text-slate-400 border border-slate-700 uppercase tracking-widest italic shadow-lg">Soru {curIdx+1} / {sessionData.questions.length}</span>
                            <div className="flex items-center gap-3">
                                <div className={`flex items-center gap-2 font-mono font-black text-xl ${timer < 10 && sessionData.duration < UNLIMITED_DURATION_THRESHOLD ? 'text-red-500 animate-pulse' : 'text-emerald-400'}`}>
                                    <Clock className="w-5 h-5" /> 
                                    {sessionData.duration >= UNLIMITED_DURATION_THRESHOLD ? "∞" : formatTime(timer)}
                                </div>
                                <button onClick={exitQuiz} className="p-2 hover:bg-slate-800/50 rounded-full text-slate-500 hover:text-red-400 transition-colors">
                                    <LogOut className="w-5 h-5" />
                                </button>
                            </div>
                        </div>
                        <div className="glass-panel p-8 md:p-10 rounded-[2.5rem] shadow-2xl mb-8 border-indigo-500/10">
                            <h3 className="text-xl md:text-2xl font-bold leading-tight text-center text-white drop-shadow-lg">{q.text}</h3>
                        </div>
                        <div className="space-y-4">
                            {q.options.map((opt, i) => {
                                const isSelected = answers[q.id] === i;
                                const isCorrect = q.correct === i;
                                
                                // Stil Mantığı
                                let btnClass = "w-full text-left p-6 rounded-2xl border-2 transition-all duration-200 flex justify-between items-center group shadow-lg ";
                                let icon = null;

                                if (showFeedback) {
                                    // Feedback Modu
                                    if (isCorrect) {
                                        // Doğru Şık: Yeşil
                                        btnClass += "border-emerald-500 bg-emerald-600 text-white shadow-[0_0_30px_rgba(16,185,129,0.4)] scale-105 z-10";
                                        icon = <CheckCircle className="w-5 h-5 text-white" />;
                                    } else if (isSelected) {
                                        // Yanlış Seçilmiş: Kırmızı
                                        btnClass += "border-red-500 bg-red-600 text-white shadow-[0_0_30px_rgba(239,68,68,0.4)] opacity-90";
                                        icon = <XCircle className="w-5 h-5 text-white" />;
                                    } else {
                                        // Diğerleri: Sönük
                                        btnClass += "border-slate-800 bg-slate-900/50 text-slate-500 opacity-50 grayscale";
                                    }
                                } else {
                                    // Normal Mod
                                    if (isSelected) {
                                        btnClass += "border-indigo-500 bg-indigo-600/20 text-white translate-x-1 shadow-indigo-900/30 active:scale-[0.98]";
                                        icon = <CheckCircle className="w-4 h-4 text-indigo-600" />;
                                    } else {
                                        btnClass += "border-slate-700 bg-slate-800/40 hover:border-slate-500 hover:bg-slate-800/60 text-slate-300 active:scale-[0.98]";
                                        icon = <div className="w-4 h-4 rounded-full border-2 border-slate-600 group-hover:border-slate-400" />;
                                    }
                                }

                                return (
                                    <button 
                                        key={i} 
                                        onClick={() => handleAnswer(q.id, i)} 
                                        disabled={showFeedback} // Feedback sırasında tıklanamaz
                                        className={btnClass}
                                    >
                                        <span className="font-bold text-base tracking-wide flex-1 break-words pr-2">{opt}</span>
                                        <div className="flex-shrink-0">{icon}</div>
                                    </button>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Ana Uygulama ---
        function App() {
            const [view, setView] = useState('landing');
            const [username, setUsername] = useState('');
            const [sessionData, setSessionData] = useState({ status: 'waiting', questions: [], participants: [], duration: 60 });
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            // Admin / Kill Switch States
            const [showAdminModal, setShowAdminModal] = useState(false);
            const [adminCode, setAdminCode] = useState('');

            // P2P Refs
            const sessionDataRef = useRef(sessionData);
            const peerRef = useRef(null);
            const connections = useRef([]);
            const activeConn = useRef(null);
            
            // Ref update
            useEffect(() => { sessionDataRef.current = sessionData; }, [sessionData]);

            // Müzik Durum Kontrolü
            useEffect(() => {
                if (sessionData.status === 'active') {
                    // Müzik başlat, süre sınırsız mı kontrol et
                    const isUnlimited = sessionData.duration >= UNLIMITED_DURATION_THRESHOLD;
                    SoundEngine.playMusic(isUnlimited);
                } else {
                    SoundEngine.stopMusic();
                }
            }, [sessionData.status]);

            // --- PENCERE KAPATILINCA BAĞLANTIYI KES (FIX) ---
            useEffect(() => {
                const cleanup = () => {
                    if (activeConn.current) {
                        activeConn.current.close();
                    }
                    if (peerRef.current) {
                        peerRef.current.destroy();
                    }
                };
                window.addEventListener('beforeunload', cleanup);
                window.addEventListener('pagehide', cleanup); // Mobile support
                return () => {
                    window.removeEventListener('beforeunload', cleanup);
                    window.removeEventListener('pagehide', cleanup);
                };
            }, []);

            // --- ADMIN / KILL SWITCH KEY LISTENER ---
            useEffect(() => {
                const handleKeyDown = (e) => {
                    // CTRL + SHIFT + K
                    if (e.ctrlKey && e.shiftKey && (e.key === 'K' || e.key === 'k')) {
                        e.preventDefault();
                        setShowAdminModal(true);
                        SoundEngine.play('destruct');
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, []);

            const handleKillRoom = () => {
                if (adminCode !== ADMIN_KILL_CODE) {
                    SoundEngine.play('error');
                    alert("GEÇERSİZ ERİŞİM KODU");
                    return;
                }

                if (confirm("DİKKAT: Bu işlem mevcut 'HOST' odasına imha sinyali gönderir ve odayı zorla kapatır. Emin misiniz?")) {
                    SoundEngine.play('destruct');
                    setLoading(true);
                    setShowAdminModal(false);
                    setAdminCode('');

                    try {
                        const tempPeer = new Peer();
                        tempPeer.on('open', () => {
                            const conn = tempPeer.connect(FIXED_ROOM_ID);
                            
                            conn.on('open', () => {
                                conn.send({ type: 'ADMIN_KILL', code: ADMIN_KILL_CODE });
                                setTimeout(() => {
                                    conn.close();
                                    tempPeer.destroy();
                                    setLoading(false);
                                    alert("İMHA SİNYALİ GÖNDERİLDİ.");
                                }, 1000);
                            });

                            conn.on('error', () => {
                                setLoading(false);
                                alert("Odaya bağlanılamadı. Oda zaten kapalı olabilir.");
                            });
                        });
                        
                        tempPeer.on('error', (err) => {
                             setLoading(false);
                             alert("Hata: " + err.type);
                        });

                    } catch (e) {
                        setLoading(false);
                        alert("İşlem başarısız.");
                    }
                }
            };

            const createHost = async () => {
                SoundEngine.play('host_create');
                setLoading(true);
                setError('');
                const code = FIXED_ROOM_ID;
                
                try {
                    const peer = new Peer(code);
                    peerRef.current = peer;

                    peer.on('open', (id) => {
                        const questions = [...QUESTION_POOL].sort(() => 0.5 - Math.random()).slice(0, 5);
                        setSessionData({ status: 'waiting', questions, participants: [], duration: 60 });
                        setLoading(false);
                        setView('host');
                    });

                    peer.on('connection', (conn) => {
                        connections.current.push(conn);
                        conn.on('open', () => {
                            conn.send({ type: 'UPDATE', data: sessionDataRef.current });
                        });
                        conn.on('data', (msg) => {
                            if (msg.type === 'ADMIN_KILL') {
                                if (msg.code === ADMIN_KILL_CODE) {
                                    SoundEngine.play('error');
                                    peer.destroy();
                                    setView('landing');
                                    setError("YÖNETİCİ TARAFINDAN ODA ZORLA KAPATILDI (KILL SIGNAL).");
                                    return;
                                }
                            }
                            if (msg.type === 'JOIN') SoundEngine.play('join_button');
                            if (msg.type === 'JOIN' || msg.type === 'PROGRESS' || msg.type === 'SUBMIT') {
                                setSessionData(prev => {
                                    const exists = prev.participants.some(p => p.uid === conn.peer);
                                    let updatedParticipants;
                                    const newUserData = { 
                                        uid: conn.peer, 
                                        username: msg.payload.username, 
                                        score: msg.payload.score || 0, 
                                        answers: msg.payload.answers || {},
                                        isFinished: msg.payload.isFinished || false,
                                        completionTime: msg.payload.completionTime // Süreyi kaydet
                                    };

                                    if (exists) {
                                        updatedParticipants = prev.participants.map(p => p.uid === conn.peer ? { ...p, ...newUserData } : p);
                                    } else {
                                        updatedParticipants = [...prev.participants, newUserData];
                                    }

                                    const updatedSession = { ...prev, participants: updatedParticipants };
                                    connections.current.forEach(c => {
                                        if (c.open) c.send({ type: 'UPDATE', data: updatedSession });
                                    });
                                    return updatedSession;
                                });
                            }
                        });
                        conn.on('close', () => {
                            setSessionData(prev => {
                                const updatedParticipants = prev.participants.filter(p => p.uid !== conn.peer);
                                const updatedSession = { ...prev, participants: updatedParticipants };
                                connections.current = connections.current.filter(c => c !== conn);
                                connections.current.forEach(c => {
                                    if (c.open) c.send({ type: 'UPDATE', data: updatedSession });
                                });
                                return updatedSession;
                            });
                        });
                    });

                    peer.on('error', (err) => {
                        if (err.type === 'unavailable-id') {
                            setError("Başka oda kurulu.");
                            setLoading(false);
                        } else {
                            setError("Ağ Hatası: " + err.message);
                            setLoading(false);
                        }
                    });

                } catch (e) {
                    setError("PeerJS başlatılamadı.");
                    setLoading(false);
                }
            };

            const joinSession = async () => {
                SoundEngine.play('join_button');
                if (!username) return setError("Lütfen bir isim girin.");
                setLoading(true);
                setError('');

                try {
                    const peer = new Peer();
                    peerRef.current = peer;

                    peer.on('open', (id) => {
                        const conn = peer.connect(FIXED_ROOM_ID);
                        activeConn.current = conn;

                        conn.on('open', () => {
                            setLoading(false);
                            setView('participant');
                            conn.send({ type: 'JOIN', payload: { username } }); 
                        });

                        conn.on('data', (msg) => {
                            if (msg.type === 'UPDATE') {
                                setSessionData(msg.data);
                            }
                        });

                        conn.on('close', () => {
                            setError("Oturum sahibi bağlantıyı kesti.");
                            setView('landing');
                        });

                        setTimeout(() => {
                            if(!activeConn.current?.open) {
                                setError("Odaya bağlanılamadı. Oturum sahibi henüz başlatmamış olabilir.");
                                setLoading(false);
                            }
                        }, 5000);
                    });

                    peer.on('error', (err) => {
                        setError("Oda bulunamadı veya bağlantı hatası.");
                        setLoading(false);
                    });

                } catch (e) {
                    setError("Bağlantı motoru hatası.");
                    setLoading(false);
                }
            };

            let content;
            if (view === 'landing') {
                content = (
                    <div className="flex flex-col items-center justify-center min-h-[100dvh] p-4 animate-fade-in relative">
                        {/* ADMIN MODAL */}
                        {showAdminModal && (
                            <div className="fixed inset-0 z-[100] bg-black flex items-center justify-center p-4 admin-overlay">
                                <div className="w-full max-w-md bg-black border-2 border-red-600 p-8 shadow-[0_0_50px_rgba(220,38,38,0.5)] font-mono relative overflow-hidden">
                                    <div className="absolute top-0 left-0 w-full h-1 bg-red-600 animate-scan"></div>
                                    <div className="flex justify-between items-start mb-8">
                                        <h2 className="text-3xl font-black text-red-600 tracking-widest glitch-text">SİSTEM_KİLİDİ</h2>
                                        <button onClick={() => setShowAdminModal(false)} className="text-red-600 hover:text-white"><XCircle /></button>
                                    </div>
                                    <div className="space-y-6">
                                        <div className="border border-red-900/50 bg-red-900/10 p-4">
                                            <p className="text-red-500 text-xs leading-relaxed uppercase">Uyarı: Yetkisiz erişim tespit edildiğinde IP adresiniz kayıt altına alınır.</p>
                                        </div>
                                        <div className="space-y-2">
                                            <label className="text-red-600 text-xs font-bold uppercase tracking-widest">Güvenlik Protokol Kodu</label>
                                            <div className="flex items-center border-b-2 border-red-600 pb-2">
                                                <ShieldAlert className="w-5 h-5 text-red-600 mr-3" />
                                                <input type="password" className="bg-transparent w-full outline-none text-red-500 font-bold tracking-[0.5em] text-center uppercase" autoFocus value={adminCode} onChange={(e) => setAdminCode(e.target.value.toUpperCase())} placeholder="_____" maxLength={5} />
                                            </div>
                                        </div>
                                        <button onClick={handleKillRoom} className="w-full bg-red-600 hover:bg-red-700 text-black font-black py-4 uppercase tracking-widest hover:scale-[1.02] transition-transform"><span className="flex items-center justify-center gap-2"><Lock className="w-4 h-4" /> HOST ODASINI İMHA ET</span></button>
                                    </div>
                                </div>
                            </div>
                        )}
                        <div className="w-full max-w-md glass-panel rounded-[3rem] p-8 shadow-2xl relative overflow-hidden border border-white/10">
                            <div className="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-indigo-500 via-purple-500 to-emerald-500" />
                            <div className="flex justify-center mb-8"><div className="bg-gradient-to-br from-indigo-500/20 to-purple-500/20 p-6 rounded-[2rem] border border-indigo-500/30 shadow-inner"><Brain className="w-16 h-16 text-indigo-400 drop-shadow-[0_0_15px_rgba(99,102,241,0.5)]" /></div></div>
                            <h1 className="text-4xl font-black text-center mb-2 tracking-tighter uppercase italic text-white drop-shadow-lg">ASRIN İMTİHANI</h1>
                            <p className="text-slate-400 text-center mb-12 text-[10px] font-black uppercase tracking-[0.3em] opacity-80">İKTİSAT, DİN, PRAKSİYOLOJİ</p>
                            <div className="space-y-5">
                                <button onClick={() => createHost()} disabled={loading} className="group w-full bg-indigo-600 hover:bg-indigo-500 py-4 rounded-2xl font-black text-sm uppercase tracking-widest text-white transition-all shadow-xl shadow-indigo-900/40 flex items-center justify-center gap-3 active:scale-95 transform border border-indigo-400/20"><Users className="w-5 h-5 group-hover:rotate-12 transition-transform" /> OTURUMU BAŞLAT (HOST)</button>
                                <div className="relative py-6"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-white/10" /></div><div className="relative flex justify-center text-[10px] font-black uppercase tracking-widest text-slate-500"><span className="px-4 bg-[#0f172a] rounded-full">Veya Katıl</span></div></div>
                                <div className="space-y-3">
                                    <div className="relative group"><div className="absolute inset-y-0 left-4 flex items-center pointer-events-none"><UserPlus className="w-5 h-5 text-slate-500 group-focus-within:text-emerald-400 transition-colors" /></div><input type="text" placeholder="İSMİNİZİ YAZIN" className="w-full bg-slate-900/50 border-2 border-slate-700 rounded-2xl pl-12 pr-4 py-4 text-sm focus:border-emerald-500 focus:bg-slate-950 transition-all outline-none font-bold text-white placeholder:text-slate-600 shadow-inner" value={username} onChange={e=>setUsername(e.target.value)} /></div>
                                    <button onClick={joinSession} disabled={loading} className="w-full bg-emerald-600 hover:bg-emerald-500 py-4 rounded-2xl font-black text-sm uppercase tracking-widest transition-all shadow-xl shadow-emerald-900/30 active:scale-95 text-white mt-2 border border-emerald-400/20">KATIL</button>
                                </div>
                                {error && <div className="bg-red-500/10 border border-red-500/20 p-4 rounded-2xl text-red-400 text-[10px] font-black uppercase text-center mt-4 flex items-center justify-center gap-2 animate-pulse"><AlertCircle className="w-4 h-4" /> {error}</div>}
                            </div>
                        </div>
                        <div className="mt-4 text-[9px] font-black text-slate-600 uppercase tracking-widest flex items-center gap-2">CANLI SUNUCU</div>
                    </div>
                );
            } else if (view === 'host' && sessionData) {
                 content = <HostPanel sessionData={sessionData} setSessionData={setSessionData} setView={setView} connections={connections} />;
            } else if (view === 'participant' && sessionData) {
                 content = <ParticipantPanel initialUsername={username} sessionData={sessionData} conn={activeConn.current} />;
            } else {
                 content = <div className="h-[100dvh] flex flex-col items-center justify-center bg-slate-950 font-black italic tracking-tighter text-indigo-500 text-2xl animate-pulse uppercase"><Brain className="w-12 h-12 mb-4" /> Yükleniyor...</div>;
            }

            return (
                <>{content}</>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
